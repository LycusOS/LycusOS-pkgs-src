#!/bin/bash

parted -s /dev/sda -- mklabel gpt
parted -s /dev/sda -- mkpart primary fat32 1MiB 256MiB
parted -s /dev/sda -- mkpart primary btrfs 256MiB 100%

parted -s /dev/sda -- set 1 esp on

mkfs.fat -F 32 -n boot /dev/sda1
mkfs.btrfs -L root /dev/sda2

mount /dev/sda2 /mnt

btrfs subvol create /mnt/@root
btrfs subvol create /mnt/@home

umount -lR /mnt

mount -o subvol=@root /dev/sda2 /mnt

mkdir /mnt/boot
mkdir /mnt/boot/efi
mkdir /mnt/home

mount -o subvol=@home /dev/sda2 /mnt/home

mount /dev/sda1 /mnt/boot/efi

pacstrap /mnt base linux-zen btrfs-progs

genfstab -L /mnt > /mnt/etc/fstab

if [[ -z $(grep 'LycusOS' /mnt/etc/pacman.conf) ]] ; then
cat << EOF >> /mnt/etc/pacman.conf

[LycusOS-pkgs-repo]
SigLevel = Optional TrustAll
Server = https://lycusos.github.io/LycusOS-pkgs-repo/\$arch
EOF
fi

arch-chroot /mnt pacman -Sy --noconfirm lycusos-hooks grub efibootmgr

ln -sf /mnt/usr/share/zoneinfo/Asia/Kolkata /mnt/etc/localtime

arch-chroot /mnt hwclock --systohc

sed -i 's|#en_US.U|en_US.U|' /mnt/etc/locale.gen

arch-chroot /mnt locale-gen

echo 'LANG=en_US.UTF-8' > /mnt/etc/locale.conf

echo 'silver' > /mnt/etc/hostname

cat << EOF > /mnt/etc/hosts
127.0.0.1   localhost
::1         localhost
127.0.1.1   silver.localdomain  silver
EOF

arch-chroot /mnt mkinitcpio -P

arch-chroot /mnt passwd

arch-chroot /mnt grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=LycusOS
arch-chroot /mnt grub-mkconfig -o /boot/grub/grub.cfg
